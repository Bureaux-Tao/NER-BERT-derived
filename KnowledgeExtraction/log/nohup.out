Using TensorFlow backend.
/home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/tensorflow/python/framework/dtypes.py:516: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_qint8 = np.dtype([("qint8", np.int8, 1)])
/home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/tensorflow/python/framework/dtypes.py:517: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_quint8 = np.dtype([("quint8", np.uint8, 1)])
/home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/tensorflow/python/framework/dtypes.py:518: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_qint16 = np.dtype([("qint16", np.int16, 1)])
/home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/tensorflow/python/framework/dtypes.py:519: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_quint16 = np.dtype([("quint16", np.uint16, 1)])
/home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/tensorflow/python/framework/dtypes.py:520: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_qint32 = np.dtype([("qint32", np.int32, 1)])
/home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/tensorflow/python/framework/dtypes.py:525: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  np_resource = np.dtype([("resource", np.ubyte, 1)])
/home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/tensorboard/compat/tensorflow_stub/dtypes.py:541: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_qint8 = np.dtype([("qint8", np.int8, 1)])
/home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/tensorboard/compat/tensorflow_stub/dtypes.py:542: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_quint8 = np.dtype([("quint8", np.uint8, 1)])
/home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/tensorboard/compat/tensorflow_stub/dtypes.py:543: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_qint16 = np.dtype([("qint16", np.int16, 1)])
/home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/tensorboard/compat/tensorflow_stub/dtypes.py:544: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_quint16 = np.dtype([("quint16", np.uint16, 1)])
/home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/tensorboard/compat/tensorflow_stub/dtypes.py:545: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_qint32 = np.dtype([("qint32", np.int32, 1)])
/home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/tensorboard/compat/tensorflow_stub/dtypes.py:550: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  np_resource = np.dtype([("resource", np.ubyte, 1)])
WARNING:tensorflow:From /home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/keras/backend/tensorflow_backend.py:517: The name tf.placeholder is deprecated. Please use tf.compat.v1.placeholder instead.
WARNING:tensorflow:From /home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/keras/backend/tensorflow_backend.py:4185: The name tf.truncated_normal is deprecated. Please use tf.random.truncated_normal instead.
WARNING:tensorflow:From /home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/keras/backend/tensorflow_backend.py:74: The name tf.get_default_graph is deprecated. Please use tf.compat.v1.get_default_graph instead.
WARNING:tensorflow:From /home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/keras/backend/tensorflow_backend.py:174: The name tf.get_default_session is deprecated. Please use tf.compat.v1.get_default_session instead.
WARNING:tensorflow:From /home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/keras/backend/tensorflow_backend.py:181: The name tf.ConfigProto is deprecated. Please use tf.compat.v1.ConfigProto instead.
2022-01-07 11:39:21.548841: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 AVX512F FMA
2022-01-07 11:39:21.557972: I tensorflow/stream_executor/platform/default/dso_loader.cc:42] Successfully opened dynamic library libcuda.so.1
2022-01-07 11:39:22.065503: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x5643f2d15bd0 executing computations on platform CUDA. Devices:
2022-01-07 11:39:22.065566: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): Graphics Device, Compute Capability 7.0
2022-01-07 11:39:22.069749: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 2400000000 Hz
2022-01-07 11:39:22.072949: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x5643f2e569b0 executing computations on platform Host. Devices:
2022-01-07 11:39:22.073006: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): <undefined>, <undefined>
2022-01-07 11:39:22.074753: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1640] Found device 0 with properties:
name: Graphics Device major: 7 minor: 0 memoryClockRate(GHz): 1.597
pciBusID: 0000:3b:00.0
2022-01-07 11:39:22.075198: I tensorflow/stream_executor/platform/default/dso_loader.cc:42] Successfully opened dynamic library libcudart.so.10.0
2022-01-07 11:39:22.077431: I tensorflow/stream_executor/platform/default/dso_loader.cc:42] Successfully opened dynamic library libcublas.so.10.0
2022-01-07 11:39:22.079481: I tensorflow/stream_executor/platform/default/dso_loader.cc:42] Successfully opened dynamic library libcufft.so.10.0
2022-01-07 11:39:22.079947: I tensorflow/stream_executor/platform/default/dso_loader.cc:42] Successfully opened dynamic library libcurand.so.10.0
2022-01-07 11:39:22.082772: I tensorflow/stream_executor/platform/default/dso_loader.cc:42] Successfully opened dynamic library libcusolver.so.10.0
2022-01-07 11:39:22.084938: I tensorflow/stream_executor/platform/default/dso_loader.cc:42] Successfully opened dynamic library libcusparse.so.10.0
2022-01-07 11:39:22.091022: I tensorflow/stream_executor/platform/default/dso_loader.cc:42] Successfully opened dynamic library libcudnn.so.7
2022-01-07 11:39:22.093755: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1763] Adding visible gpu devices: 0
2022-01-07 11:39:22.093818: I tensorflow/stream_executor/platform/default/dso_loader.cc:42] Successfully opened dynamic library libcudart.so.10.0
2022-01-07 11:39:22.097989: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1181] Device interconnect StreamExecutor with strength 1 edge matrix:
2022-01-07 11:39:22.098021: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1187]      0
2022-01-07 11:39:22.098041: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1200] 0:   N
2022-01-07 11:39:22.101605: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1326] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 30458 MB memory) -> physical GPU (device: 0, name: Graphics Device, pci bus id: 0000:3b:00.0, compute capability: 7.0)
WARNING:tensorflow:From /home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/tensorflow/python/ops/nn_impl.py:180: add_dispatch_support.<locals>.wrapper (from tensorflow.python.ops.array_ops) is deprecated and will be removed in a future version.
Instructions for updating:
Use tf.where in 2.0, which has the same broadcast rule as np.where
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to
==================================================================================================
Input-Token (InputLayer)        (None, None)         0
__________________________________________________________________________________________________
Input-Segment (InputLayer)      (None, None)         0
__________________________________________________________________________________________________
Embedding-Token (Embedding)     (None, None, 312)    6591936     Input-Token[0][0]
__________________________________________________________________________________________________
Embedding-Segment (Embedding)   (None, None, 312)    624         Input-Segment[0][0]
__________________________________________________________________________________________________
Embedding-Token-Segment (Add)   (None, None, 312)    0           Embedding-Token[0][0]
                                                                 Embedding-Segment[0][0]
__________________________________________________________________________________________________
Embedding-Position (PositionEmb (None, None, 312)    159744      Embedding-Token-Segment[0][0]
__________________________________________________________________________________________________
Embedding-Norm (LayerNormalizat (None, None, 312)    624         Embedding-Position[0][0]
__________________________________________________________________________________________________
Transformer-MultiHeadSelfAttent (None, None, 312)    390624      Embedding-Norm[0][0]
                                                                 Embedding-Norm[0][0]
                                                                 Embedding-Norm[0][0]
                                                                 Transformer-FeedForward-Norm[0][0
                                                                 Transformer-FeedForward-Norm[0][0
                                                                 Transformer-FeedForward-Norm[0][0
                                                                 Transformer-FeedForward-Norm[1][0
                                                                 Transformer-FeedForward-Norm[1][0
                                                                 Transformer-FeedForward-Norm[1][0
                                                                 Transformer-FeedForward-Norm[2][0
                                                                 Transformer-FeedForward-Norm[2][0
                                                                 Transformer-FeedForward-Norm[2][0
__________________________________________________________________________________________________
Transformer-MultiHeadSelfAttent (None, None, 312)    0           Embedding-Norm[0][0]
                                                                 Transformer-MultiHeadSelfAttentio
                                                                 Transformer-FeedForward-Norm[0][0
                                                                 Transformer-MultiHeadSelfAttentio
                                                                 Transformer-FeedForward-Norm[1][0
                                                                 Transformer-MultiHeadSelfAttentio
                                                                 Transformer-FeedForward-Norm[2][0
                                                                 Transformer-MultiHeadSelfAttentio
__________________________________________________________________________________________________
Transformer-MultiHeadSelfAttent (None, None, 312)    624         Transformer-MultiHeadSelfAttentio
                                                                 Transformer-MultiHeadSelfAttentio
                                                                 Transformer-MultiHeadSelfAttentio
                                                                 Transformer-MultiHeadSelfAttentio
__________________________________________________________________________________________________
Transformer-FeedForward (FeedFo (None, None, 312)    780312      Transformer-MultiHeadSelfAttentio
                                                                 Transformer-MultiHeadSelfAttentio
                                                                 Transformer-MultiHeadSelfAttentio
                                                                 Transformer-MultiHeadSelfAttentio
__________________________________________________________________________________________________
Transformer-FeedForward-Add (Ad (None, None, 312)    0           Transformer-MultiHeadSelfAttentio
                                                                 Transformer-FeedForward[0][0]
                                                                 Transformer-MultiHeadSelfAttentio
                                                                 Transformer-FeedForward[1][0]
                                                                 Transformer-MultiHeadSelfAttentio
                                                                 Transformer-FeedForward[2][0]
                                                                 Transformer-MultiHeadSelfAttentio
                                                                 Transformer-FeedForward[3][0]
__________________________________________________________________________________________________
Transformer-FeedForward-Norm (L (None, None, 312)    624         Transformer-FeedForward-Add[0][0]
                                                                 Transformer-FeedForward-Add[1][0]
                                                                 Transformer-FeedForward-Add[2][0]
                                                                 Transformer-FeedForward-Add[3][0]
__________________________________________________________________________________________________
Subject-Ids (InputLayer)        (None, 2)            0
__________________________________________________________________________________________________
lambda_2 (Lambda)               (None, 624)          0           Transformer-FeedForward-Add[3][0]
                                                                 Subject-Ids[0][0]
__________________________________________________________________________________________________
layer_normalization_1 (LayerNor (None, None, 312)    390000      Transformer-FeedForward-Add[3][0]
                                                                 lambda_2[0][0]
__________________________________________________________________________________________________
dense_10 (Dense)                (None, None, 98)     30674       layer_normalization_1[0][0]
__________________________________________________________________________________________________
dense_7 (Dense)                 (None, None, 2)      626         Transformer-FeedForward-Norm[3][0
__________________________________________________________________________________________________
lambda_3 (Lambda)               (None, None, 98)     0           dense_10[0][0]
__________________________________________________________________________________________________
Subject-Labels (InputLayer)     (None, None, 2)      0
__________________________________________________________________________________________________
Object-Labels (InputLayer)      (None, None, 49, 2)  0
__________________________________________________________________________________________________
lambda_1 (Lambda)               (None, None, 2)      0           dense_7[0][0]
__________________________________________________________________________________________________
reshape_1 (Reshape)             (None, None, 49, 2)  0           lambda_3[0][0]
__________________________________________________________________________________________________
total_loss_1 (TotalLoss)        [(None, None, 2), (N 0           Subject-Labels[0][0]
                                                                 Object-Labels[0][0]
                                                                 lambda_1[0][0]
                                                                 reshape_1[0][0]
                                                                 Transformer-FeedForward-Norm[3][0
==================================================================================================
Total params: 8,346,412
Trainable params: 8,346,412
Non-trainable params: 0
__________________________________________________________________________________________________
WARNING:tensorflow:From /home/bureaux/miniconda3/envs/Keras-base/lib/python3.6/site-packages/keras/optimizers.py:790: The name tf.train.Optimizer is deprecated. Please use tf.compat.v1.train.Optimizer instead.
Epoch 1/50
2022-01-07 11:39:31.246486: I tensorflow/stream_executor/platform/default/dso_loader.cc:42] Successfully opened dynamic library libcublas.so.10.0
1352/1352 [==============================] - 188s 139ms/step - loss: 0.1195
f1: 0.65316, precision: 0.87004, recall: 0.52283: : 21626it [05:52, 61.33it/s]
best f1: 0.65316
Epoch 2/50
1352/1352 [==============================] - 163s 120ms/step - loss: 0.0524
f1: 0.72665, precision: 0.83884, recall: 0.64094: : 21626it [06:03, 59.49it/s]
best f1: 0.72665
Epoch 3/50
1352/1352 [==============================] - 161s 119ms/step - loss: 0.0459
f1: 0.75080, precision: 0.83222, recall: 0.68389: : 21626it [06:04, 59.32it/s]
best f1: 0.75080
Epoch 4/50
1352/1352 [==============================] - 161s 119ms/step - loss: 0.0416
f1: 0.76413, precision: 0.83040, recall: 0.70765: : 21626it [06:05, 59.15it/s]
best f1: 0.76413
Epoch 5/50
1352/1352 [==============================] - 165s 122ms/step - loss: 0.0387
f1: 0.77121, precision: 0.83037, recall: 0.71993: : 21626it [06:18, 57.17it/s]
best f1: 0.77121
Epoch 6/50
1352/1352 [==============================] - 159s 118ms/step - loss: 0.0361
f1: 0.77593, precision: 0.83065, recall: 0.72797: : 21626it [06:09, 58.53it/s]
best f1: 0.77593
Epoch 7/50
1352/1352 [==============================] - 159s 118ms/step - loss: 0.0338
f1: 0.77921, precision: 0.83004, recall: 0.73425: : 21626it [06:13, 57.88it/s]
best f1: 0.77921
Epoch 8/50
1352/1352 [==============================] - 159s 118ms/step - loss: 0.0318
f1: 0.78107, precision: 0.82972, recall: 0.73781: : 21626it [06:09, 58.45it/s]
best f1: 0.78107
Epoch 9/50
1352/1352 [==============================] - 158s 117ms/step - loss: 0.0298
f1: 0.78055, precision: 0.82883, recall: 0.73759: : 21626it [06:10, 58.31it/s]
Early stop count 1/3
best f1: 0.78107
Epoch 10/50
1352/1352 [==============================] - 158s 117ms/step - loss: 0.0281
f1: 0.78088, precision: 0.82799, recall: 0.73884: : 21626it [06:11, 58.22it/s]
Early stop count 2/3
best f1: 0.78107
Epoch 11/50
1352/1352 [==============================] - 158s 117ms/step - loss: 0.0263
f1: 0.78116, precision: 0.82647, recall: 0.74055: : 21626it [06:11, 58.14it/s]
best f1: 0.78116
Epoch 12/50
1352/1352 [==============================] - 159s 117ms/step - loss: 0.0247
f1: 0.77995, precision: 0.82590, recall: 0.73884: : 21626it [06:11, 58.18it/s]
Early stop count 1/3
best f1: 0.78116
Epoch 13/50
1352/1352 [==============================] - 158s 117ms/step - loss: 0.0232
f1: 0.77926, precision: 0.82471, recall: 0.73855: : 21626it [06:12, 58.10it/s]
Early stop count 2/3
best f1: 0.78116
Epoch 14/50
1352/1352 [==============================] - 158s 117ms/step - loss: 0.0217
f1: 0.77887, precision: 0.82440, recall: 0.73811: : 21626it [06:14, 57.81it/s]
Early stop count 3/3
best f1: 0.78116
Epoch 14: early stopping THR